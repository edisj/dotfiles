return {
	"quarto-dev/quarto-nvim",
	dependencies = {
		"jmbuhr/otter.nvim",
		"nvim-treesitter/nvim-treesitter",
		"neovim/nvim-lspconfig",
		"nvim-cmp",
	},
	ft = { "markdown", "quarto" },
	config = function()
		local quarto = require("quarto")

		quarto.setup({
			lspFeatures = {
				enabled = true,
				chunks = "all",
				languages = { "python", "bash" },
				diagnostics = {
					enabled = true,
					triggers = { "BufWritePost" },
				},
				completion = {
					enabled = true,
				},
			},
			codeRunner = {
				enabled = true,
				default_method = "molten",
			},
			keymap = {
				-- set `false` to disable
				hover = "K",
				definition = "gd",
				type_definition = "gD",
				rename = "<leader>rn",
				format = "<leader>FM",
				references = "gr",
				document_symbols = "gS",
			},
		})

        ---@return boolean
		local function is_code_chunk()
			local current, _ = require("otter.keeper").get_current_language_context()
			if current then
				return true
			else
				return false
			end
		end

		--- Insert code chunk of given language
		--- Splits current chunk if already within a chunk
        --- @param lang string
		local function insert_code_chunk(lang)
			vim.api.nvim_feedkeys(vim.api.nvim_replace_termcodes("<esc>", true, false, true), "n", true)
			local keys
			if is_code_chunk() then
				keys = [[o```<cr><cr>```{]] .. lang .. [[}<esc>o]]
			else
				keys = [[o```{]] .. lang .. [[}<cr>```<esc>O]]
			end
			keys = vim.api.nvim_replace_termcodes(keys, true, false, true)
			vim.api.nvim_feedkeys(keys, "n", false)
		end

		local function insert_py_chunk()
			insert_code_chunk("python")
		end

		local function insert_lua_chunk()
			insert_code_chunk("lua")
		end

        -- stylua: ignore
        vim.keymap.set("n", "<C-M-i>", insert_py_chunk,  { desc = "Insert python code chunk" })
        vim.keymap.set("n", "<S-M-i>", insert_lua_chunk, { desc = "Insert lua code chunk" })

        local runner = require("quarto.runner")
        vim.keymap.set("n", "<C-r>",      runner.run_cell,  { desc = "run cell", silent = true })
        vim.keymap.set("n", "<leader>RO", runner.run_above, { desc = "run cell and above", silent = true })
        vim.keymap.set("n", "<leader>ro", runner.run_all,   { desc = "run all cells", silent = true })
        vim.keymap.set("n", "<leader>rl", runner.run_line,  { desc = "run line", silent = true })
        vim.keymap.set("v", "<leader>r",  runner.run_range, { desc = "run visual range", silent = true })
	end,
}
