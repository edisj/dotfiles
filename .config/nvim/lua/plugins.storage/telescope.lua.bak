local function focus_preview(prompt_bufnr)
    local action_state = require("telescope.actions.state")
    local picker = action_state.get_current_picker(prompt_bufnr)
    local prompt_win = picker.prompt_win
    local previewer = picker.previewer
    local preview_winid = previewer.state.winid
    local bufnr = previewer.state.bufnr
    vim.keymap.set("n", "<Tab>", function()
        vim.cmd(string.format("noautocmd lua vim.api.nvim_set_current_win(%s)", prompt_win))
    end, { buffer = bufnr })
    vim.cmd(string.format("noautocmd lua vim.api.nvim_set_current_win(%s)", preview_winid))
end

return {
    "nvim-telescope/telescope.nvim",
    branch = "0.1.x",
    cmd = "Telescope",
    event = "VeryLazy",
    dependencies = {
        --"kkharji/sqlite.lua",
        { "nvim-telescope/telescope-fzf-native.nvim", build = "make" },
        --"nvim-telescope/telescope-ui-select.nvim",
        --"nvim-telescope/telescope-smart-history.nvim",
        -- "nvim-telescope/telescope-frecency.nvim",
        --"scottmckendry/telescope-resession.nvim",
        --"nvim-telescope/telescope-file-browser.nvim",
    },
    config = function()
        local telescope = require("telescope")
        telescope.setup({
            defaults = {
                prompt_prefix = "Ôë´  ",
                selection_caret = "Ôë† ",
                multi_icon = "Ô§ò",
                --history = {
                --    path = "~/.local/share/nvim/databases/telescope_history.sqlite3",
                --    limit = 100,
                --},
                border = true,
                --borderchars = { "‚ñî", "‚ñï", "‚ñÅ", "‚ñé", "ü≠Ω", "ü≠æ", "ü≠ø", "ü≠º" },
                path_display = { truncate = 2 },
                file_ignore_patterns = {
                    "lazy%-lock",
                },
                layout_config = {
                    scroll_speed = 4,
                    horizontal = {
                        height = 0.8,
                        width = 0.9,
                        preview_width = 0.55,
                        prompt_position = "bottom",
                    },
                },
                mappings = {
                    n = {
                        ["<C-c>"] = "close",
                        ["<Tab>"] = focus_preview,
                    },
                    i = {
                        --["<esc>"] = "close",
                        ["<C-c>"] = "close",
                        ["<C-.>"] = "close",
                        ["<C-f>"] = "close",
                        ["<C-h>"] = "close",
                        ["<C-y>"] = "select_default",
                        ["<C-j>"] = "move_selection_next",
                        ["<C-k>"] = "move_selection_previous",
                        ["<M-j>"] = "preview_scrolling_down",
                        ["<M-k>"] = "preview_scrolling_up",
                        ["<M-p>"] = require("telescope.actions.layout").toggle_preview,
                        ["<Tab>"] = focus_preview,
                        ["<C-/>"] = "which_key",
                    },
                },
            },
            pickers = {
                find_files = {
                    theme = "dropdown",
                    preview = {
                        hide_on_startup = true,
                    },
                },
            },
            extensions = {
                ["ui-select"] = {
                    require("telescope.themes").get_dropdown({}),
                },
                resession = {
                    prompt_title = "Find Sessions",
                    dir = "session",
                    path_substitutions = {
                        { find = "/home/edis", replace = "üè†" },
                    },
                },
            },
        })

        pcall(telescope.load_extension, "fzf")
        pcall(telescope.load_extension, "ui-select")
        pcall(telescope.load_extension, "noice")
        pcall(telescope.load_extension, "projects")
        pcall(telescope.load_extension, "smart_history")
        pcall(telescope.load_extension, "frecency")
        pcall(telescope.load_extension, "git_worktree")
        pcall(telescope.load_extension, "workspaces")
    end,
    keys = {
        -- {
        --     "<C-f>",
        --     function()
        --         require("telescope.builtin").find_files()
        --     end,
        --     desc = "Telescope find files",
        -- },
        { "<C-.>",      "<cmd>Telescope find_files<cr>",                               desc = "Find Files" },
        { "<leader>sf", "<cmd>Telescope find_files<cr>",                               desc = "Find Files" },
        { "<leader>.",  "<cmd>Telescope buffers sort_mru=true sort_lastused=true<cr>", desc = "Switch Buffer" },
        { "<leader>/",  "<cmd>Telescope live_grep<CR>",                                desc = "Grep (Root Dir)" },
        { "<leader>:",  "<cmd>Telescope command_history<CR>",                          desc = "Command History" },
        { '<leader>s"', "<cmd>Telescope registers<cr>",                                desc = "Registers" },
        { "<leader>sa", "<cmd>Telescope autocommands<cr>",                             desc = "Auto Commands" },
        { "<leader>sb", "<cmd>Telescope current_buffer_fuzzy_find<cr>",                desc = "Buffer" },
        { "<leader>sc", "<cmd>Telescope command_history<cr>",                          desc = "Command History" },
        { "<leader>sC", "<cmd>Telescope commands<cr>",                                 desc = "Commands" },
        { "<leader>sd", "<cmd>Telescope diagnostics bufnr=0<cr>",                      desc = "Document Diagnostics" },
        { "<leader>sD", "<cmd>Telescope diagnostics<cr>",                              desc = "Workspace Diagnostics" },
        { "<leader>sH", "<cmd>Telescope highlights<cr>",                               desc = "Search Highlight Groups" },
        { "<leader>sh", "<cmd>Telescope help_tags<cr>",                                desc = "Help Tags" },
        { "<leader>sj", "<cmd>Telescope jumplist<cr>",                                 desc = "Jumplist" },
        { "<leader>sk", "<cmd>Telescope keymaps<cr>",                                  desc = "Key Maps" },
        { "<leader>sl", "<cmd>Telescope loclist<cr>",                                  desc = "Location List" },
        { "<leader>sM", "<cmd>Telescope man_pages<cr>",                                desc = "Man Pages" },
        { "<leader>sm", "<cmd>Telescope marks<cr>",                                    desc = "Jump to Mark" },
        { "<leader>so", "<cmd>Telescope vim_options<cr>",                              desc = "Options" },
        { "<leader>sR", "<cmd>Telescope resume<cr>",                                   desc = "Resume" },
        { "<leader>sq", "<cmd>Telescope quickfix<cr>",                                 desc = "Quickfix List" },
        {
            "<leader>sw",
            function()
                local word = vim.fn.expand("<cword>")
                require("telescope.builtin").grep_string({ search = word })
            end,
            desc = "grep word",
        },
        {
            "<leader>sW",
            function()
                local word = vim.fn.expand("<cWORD>")
                require("telescope.builtin").grep_string({ search = word })
            end,
            desc = "grep WORD",
        },
        {
            "<C-/>",
            function()
                require("telescope.builtin").help_tags()
            end,
            desc = "Help Pages",
        },
        {
            "<leader>H",
            function()
                require("telescope.builtin").help_tags()
            end,
            desc = "Telescope help tags",
        },
        {
            "<leader>sp",
            function()
                local dir = vim.fn.stdpath("config") .. "/lua"
                require("telescope.builtin").find_files({ cwd = dir })
            end,
            desc = "Find neovim config",
        },
        {
            "<leader>fp",
            function()
                local dir = require("lazy.core.config").options.root
                -- vim.print(dir)
                require("telescope.builtin").find_files({ cwd = dir })
            end,
            desc = "Find Plugin File",
        },
        -- {
        --     "<leader>ps",
        --     function()
        --         local word = vim.fn.input("grep > ")
        --         require("telescope.builtin").grep_string({ search = word })
        --     end,
        -- },
        -- {
        --     "<leader>fl",
        --     function()
        --         local files = {} ---@type table<string, string>
        --         for _, plugin in pairs(require("lazy.core.config").plugins) do
        --             repeat
        --                 if plugin._.module then
        --                     local info = vim.loader.find(plugin._.module)[1]
        --                     if info then
        --                         files[info.modpath] = info.modpath
        --                     end
        --                 end
        --                 plugin = plugin._.super
        --             until not plugin
        --         end
        --         require("telescope.builtin").live_grep({
        --             default_text = "/",
        --             search_dirs = vim.tbl_values(files),
        --         })
        --     end,
        --     desc = "Find Lazy Plugin Spec",
        -- },
    },
}
